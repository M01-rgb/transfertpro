<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TransfertPro - R√©ception</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, getDocs, doc, updateDoc, query, where } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCIg0_eVtvt9eG0GnUheiFBFVJlC03ht4E",
            authDomain: "transfertpro-18a3e.firebaseapp.com",
            projectId: "transfertpro-18a3e",
            storageBucket: "transfertpro-18a3e.firebasestorage.app",
            messagingSenderId: "762619692633",
            appId: "1:762619692633:web:49d265ca2179845a831348"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        window.firebase = {
            db,
            collection,
            getDocs,
            doc,
            updateDoc,
            query,
            where
        };
    </script>
    <style>
        /* Le CSS reste exactement le m√™me que votre fichier original */
        /* ... Votre CSS complet ... */
    </style>
</head>
<body>
    <!-- Le HTML reste exactement le m√™me que votre fichier original -->
    <!-- ... Votre HTML complet ... -->

    <script>
        // √âl√©ments DOM
        const verificationForm = document.getElementById('verification-form');
        const verificationResult = document.getElementById('verification-result');
        const noResult = document.getElementById('no-result');
        const receiveForm = document.getElementById('receive-form');
        const alreadyReceived = document.getElementById('already-received');
        const confirmReceiveBtn = document.getElementById('confirm-receive-btn');
        const notificationEl = document.getElementById('notification');

        // Variable pour stocker la transaction courante
        let currentTransaction = null;

        // R√©cup√©rer les donn√©es de session si disponibles
        const receiverName = sessionStorage.getItem('receiverName');
        const transactionToCheck = sessionStorage.getItem('transactionToCheck');

        // Pr√©-remplir le formulaire si des donn√©es existent
        if (receiverName) {
            document.getElementById('receiver-name').value = receiverName;
        }
        if (transactionToCheck) {
            document.getElementById('transaction-id').value = transactionToCheck;
        }

        // Soumission du formulaire de v√©rification
        verificationForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const name = document.getElementById('receiver-name').value.trim();
            const transactionId = document.getElementById('transaction-id').value.trim().toUpperCase();

            // Animation du bouton
            const submitBtn = verificationForm.querySelector('button');
            const originalText = submitBtn.innerHTML;
            submitBtn.innerHTML = '<div class="loading"></div> V√©rification...';
            submitBtn.disabled = true;

            try {
                await verifyTransaction(name, transactionId);
            } catch (error) {
                console.error('Erreur v√©rification:', error);
                showNotification('Erreur lors de la v√©rification', 'error');
            } finally {
                // R√©activer le bouton
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
            }
        });

        // V√©rifier la transaction dans Firebase
        async function verifyTransaction(receiverName, transactionId) {
            try {
                const { db, collection, getDocs, query, where } = window.firebase;
                
                // Recherche dans Firebase
                const transactionsQuery = query(
                    collection(db, "transactions"),
                    where("id", "==", transactionId)
                );
                
                const querySnapshot = await getDocs(transactionsQuery);
                
                if (!querySnapshot.empty) {
                    const transactionDoc = querySnapshot.docs[0];
                    const transaction = { id: transactionDoc.id, ...transactionDoc.data() };
                    
                    // V√©rifier le nom du destinataire
                    const cleanReceiverName = receiverName.toLowerCase().trim();
                    const storedReceiverName = transaction.receiver.name.toLowerCase().trim();
                    const storedReceiverSurname = transaction.receiver.surname.toLowerCase().trim();
                    const fullStoredName = `${storedReceiverName} ${storedReceiverSurname}`.trim();
                    
                    const nameMatches = storedReceiverName === cleanReceiverName || 
                                       fullStoredName === cleanReceiverName ||
                                       storedReceiverName.includes(cleanReceiverName) ||
                                       cleanReceiverName.includes(storedReceiverName);
                    
                    if (nameMatches) {
                        currentTransaction = transaction;
                        displayTransactionDetails(transaction);
                        verificationResult.style.display = 'block';
                        noResult.style.display = 'none';
                        showNotification('Transfert trouv√© avec succ√®s!', 'success');
                    } else {
                        verificationResult.style.display = 'none';
                        noResult.style.display = 'block';
                        showNotification('Le nom ne correspond pas au destinataire enregistr√©', 'error');
                    }
                } else {
                    verificationResult.style.display = 'none';
                    noResult.style.display = 'block';
                    showNotification('Aucun transfert trouv√© avec ce num√©ro de transaction', 'error');
                }
            } catch (error) {
                console.error('Erreur v√©rification transaction:', error);
                throw error;
            }
        }

        // Afficher les d√©tails de la transaction
        function displayTransactionDetails(transaction) {
            // Mettre √† jour les d√©tails
            document.getElementById('detail-id').textContent = transaction.id;
            document.getElementById('detail-date').textContent = formatDate(transaction.date);
            document.getElementById('detail-sender').textContent = `${transaction.sender.name} ${transaction.sender.surname}`;
            document.getElementById('detail-receiver').textContent = `${transaction.receiver.name} ${transaction.receiver.surname}`;
            
            const direction = transaction.transferType === 'RD_HAITI' 
                ? 'üá©üá¥ R√©publique Dominicaine ‚Üí Ha√Øti üá≠üáπ' 
                : 'üá≠üáπ Ha√Øti ‚Üí R√©publique Dominicaine üá©üá¥';
            document.getElementById('detail-direction').textContent = direction;
            
            // Mettre √† jour les montants
            document.getElementById('detail-amount-sent').textContent = 
                `${transaction.amount} ${transaction.currencyFrom}`;
            document.getElementById('detail-amount-receive').textContent = 
                `${transaction.convertedAmount.toLocaleString('fr-FR')} ${transaction.currencyTo}`;
            
            // Mettre √† jour le statut
            const statusElement = document.getElementById('detail-status');
            statusElement.textContent = getStatusText(transaction.status);
            statusElement.className = `status-badge status-${transaction.status}`;
            
            // Afficher le formulaire de r√©ception ou le message "d√©j√† re√ßu"
            if (transaction.status === 'pending') {
                receiveForm.style.display = 'block';
                alreadyReceived.style.display = 'none';
                
                // Configurer le bouton de confirmation
                confirmReceiveBtn.onclick = () => confirmReceipt(transaction.id);
            } else {
                receiveForm.style.display = 'none';
                alreadyReceived.style.display = 'block';
                if (transaction.receivedDate) {
                    document.getElementById('received-date').textContent = formatDate(transaction.receivedDate);
                }
            }
        }

        // Confirmer la r√©ception avec v√©rification des identifiants
        async function confirmReceipt(transactionId) {
            const idNumber = document.getElementById('receiver-confirm-id').value.trim();
            const phone = document.getElementById('receiver-confirm-phone').value.trim();
            
            if (!idNumber || !phone) {
                showNotification('Veuillez remplir tous les champs', 'error');
                return;
            }

            // V√âRIFICATION : Comparer avec les informations originales
            if (currentTransaction) {
                const originalId = currentTransaction.receiver.id;
                const originalPhone = currentTransaction.receiver.phone;
                
                if (idNumber !== originalId) {
                    showNotification('Le num√©ro d\'identit√© ne correspond pas √† celui enregistr√© par l\'exp√©diteur', 'error');
                    return;
                }

                if (phone !== originalPhone) {
                    showNotification('Le num√©ro de t√©l√©phone ne correspond pas √† celui enregistr√© par l\'exp√©diteur', 'error');
                    return;
                }
            }

            // Animation du bouton
            const originalText = confirmReceiveBtn.innerHTML;
            confirmReceiveBtn.innerHTML = '<div class="loading"></div> Traitement...';
            confirmReceiveBtn.disabled = true;

            try {
                const { db, doc, updateDoc } = window.firebase;
                
                // Mettre √† jour la transaction dans Firebase
                await updateDoc(doc(db, "transactions", transactionId), {
                    status: 'completed',
                    received: true,
                    receivedDate: new Date().toISOString(),
                    receiver: {
                        ...currentTransaction.receiver,
                        confirmedId: idNumber,
                        confirmedPhone: phone
                    }
                });
                
                // Mettre √† jour l'affichage
                currentTransaction.status = 'completed';
                currentTransaction.received = true;
                currentTransaction.receivedDate = new Date().toISOString();
                displayTransactionDetails(currentTransaction);
                
                showNotification('R√©ception confirm√©e avec succ√®s! Les identifiants correspondent.', 'success');
                
                // Envoyer une notification √† l'exp√©diteur (simul√©)
                sendConfirmationSMS(currentTransaction);
                
            } catch (error) {
                console.error('Erreur confirmation r√©ception:', error);
                showNotification('Erreur lors de la confirmation', 'error');
            } finally {
                // R√©activer le bouton
                confirmReceiveBtn.innerHTML = originalText;
                confirmReceiveBtn.disabled = false;
            }
        }

        // Envoyer une confirmation SMS (simul√©)
        function sendConfirmationSMS(transaction) {
            console.log(`SMS envoy√© √† ${transaction.sender.phone}: 
            Bonne nouvelle! ${transaction.receiver.name} a r√©cup√©r√© le transfert de ${transaction.amount} ${transaction.currencyFrom}. 
            Transaction #${transaction.id} est maintenant compl√©t√©e.`);
            
            showNotification(`Confirmation envoy√©e √† ${transaction.sender.phone}`, 'success');
        }

        // Fonction pour afficher une notification
        function showNotification(message, type) {
            const icon = type === 'error' ? 'fa-exclamation-circle' : 'fa-check-circle';
            notificationEl.innerHTML = `<i class="fas ${icon}"></i><span>${message}</span>`;
            notificationEl.className = `notification ${type} show`;

            setTimeout(() => {
                notificationEl.classList.remove('show');
            }, 4000);
        }

        // Fonctions utilitaires
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('fr-FR') + ' √† ' + date.toLocaleTimeString('fr-FR', {hour: '2-digit', minute: '2-digit'});
        }

        function getStatusText(status) {
            const statusMap = {
                'pending': 'En attente',
                'completed': 'Compl√©t√©',
                'cancelled': 'Annul√©'
            };
            return statusMap[status] || status;
        }

        // V√©rification automatique si des donn√©es pr√©-remplies existent
        document.addEventListener('DOMContentLoaded', () => {
            if (receiverName && transactionToCheck) {
                // Lancer automatiquement la v√©rification
                setTimeout(() => {
                    verifyTransaction(receiverName, transactionToCheck);
                    
                    // Nettoyer la session
                    sessionStorage.removeItem('receiverName');
                    sessionStorage.removeItem('transactionToCheck');
                }, 500);
            }
        });
    </script>
</body>
</html>
