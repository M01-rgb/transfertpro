<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TransfertPro - R√©ception</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, getDocs, doc, updateDoc, query, where } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCIg0_eVtvt9eG0GnUheiFBFVJlC03ht4E",
            authDomain: "transfertpro-18a3e.firebaseapp.com",
            projectId: "transfertpro-18a3e",
            storageBucket: "transfertpro-18a3e.firebasestorage.app",
            messagingSenderId: "762619692633",
            appId: "1:762619692633:web:49d265ca2179845a831348"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        window.firebase = {
            db,
            collection,
            getDocs,
            doc,
            updateDoc,
            query,
            where
        };
    </script>
    <style>
        :root {
            --primary: #3498db;
            --secondary: #2ecc71;
            --danger: #e74c3c;
            --warning: #f39c12;
            --dark: #2c3e50;
            --light: #ecf0f1;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f5f7fa;
            color: #333;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            background: linear-gradient(135deg, var(--primary), var(--dark));
            color: white;
            padding: 15px 0;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .logo i {
            font-size: 32px;
        }
        
        .logo h1 {
            font-size: 24px;
            font-weight: 700;
        }
        
        .back-btn {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 1px solid rgba(255,255,255,0.3);
            padding: 10px 20px;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
            text-decoration: none;
        }
        
        .back-btn:hover {
            background: rgba(255,255,255,0.3);
            transform: translateY(-2px);
        }
        
        .card {
            background: white;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.08);
            padding: 25px;
            margin-bottom: 25px;
            border-left: 5px solid var(--secondary);
        }
        
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }
        
        .card-title {
            font-size: 20px;
            font-weight: 700;
            color: var(--dark);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .card-title i {
            color: var(--secondary);
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--dark);
        }
        
        .input-with-icon {
            position: relative;
        }
        
        .input-with-icon i {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--primary);
            font-size: 18px;
        }
        
        input, select, textarea {
            width: 100%;
            padding: 12px 15px 12px 50px;
            border: 2px solid #e1e5e9;
            border-radius: 10px;
            font-size: 15px;
            transition: all 0.3s ease;
            background: #f8f9fa;
        }
        
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--primary);
            background: white;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }
        
        button {
            padding: 12px 25px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            font-size: 15px;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn-success {
            background: linear-gradient(135deg, var(--secondary), #27ae60);
            color: white;
            box-shadow: 0 4px 15px rgba(46, 204, 113, 0.3);
        }
        
        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(46, 204, 113, 0.4);
        }
        
        .btn-primary {
            background: var(--primary);
            color: white;
        }
        
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
        }
        
        .transaction-details {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.08);
            border-left: 5px solid var(--primary);
        }
        
        .detail-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 12px;
            padding-bottom: 12px;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .detail-row:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }
        
        .detail-label {
            font-weight: 600;
            color: var(--dark);
        }
        
        .detail-value {
            color: #666;
            text-align: right;
        }
        
        .amount-highlight {
            font-size: 24px;
            font-weight: bold;
            color: var(--secondary);
            text-align: center;
            padding: 20px;
            background: linear-gradient(135deg, #f8f9fa, #fff);
            border-radius: 10px;
            margin: 20px 0;
            border: 2px dashed var(--secondary);
        }
        
        .status-badge {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .status-pending {
            background: #fff3cd;
            color: #856404;
        }
        
        .status-completed {
            background: #d4edda;
            color: #155724;
        }
        
        .verification-success {
            background: linear-gradient(135deg, var(--secondary), #27ae60);
            color: white;
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            margin: 20px 0;
        }
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 10px;
            color: white;
            box-shadow: 0 5px 20px rgba(0,0,0,0.15);
            z-index: 1000;
            transform: translateX(400px);
            transition: transform 0.3s ease;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .notification.show {
            transform: translateX(0);
        }
        
        .notification.success {
            background: linear-gradient(135deg, var(--secondary), #27ae60);
        }
        
        .notification.error {
            background: linear-gradient(135deg, var(--danger), #c0392b);
        }
        
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }
            
            .container {
                padding: 15px;
            }
            
            .grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <div class="header-content">
                <div class="logo">
                    <i class="fas fa-hand-holding-usd"></i>
                    <h1>TransfertPro - R√©ception</h1>
                </div>
                <a href="index.html" class="back-btn">
                    <i class="fas fa-arrow-left"></i> Retour √† l'accueil
                </a>
            </div>
        </div>
    </header>
    
    <div class="container">
        <!-- Formulaire de v√©rification -->
        <div class="card">
            <div class="card-header">
                <h2 class="card-title">
                    <i class="fas fa-search"></i>
                    V√©rifier un Transfert
                </h2>
            </div>
            <form id="verification-form">
                <div class="form-group">
                    <label for="receiver-name">Votre nom complet</label>
                    <div class="input-with-icon">
                        <i class="fas fa-user"></i>
                        <input type="text" id="receiver-name" required placeholder="Le nom du destinataire">
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="transaction-id">Num√©ro de transaction</label>
                    <div class="input-with-icon">
                        <i class="fas fa-receipt"></i>
                        <input type="text" id="transaction-id" required placeholder="Num√©ro √† 7 chiffres (ex: TR1234567)">
                    </div>
                </div>
                
                <button type="submit" class="btn-success">
                    <i class="fas fa-search"></i> V√©rifier le Transfert
                </button>
            </form>
        </div>

        <!-- R√©sultats de la v√©rification -->
        <div id="verification-result" style="display: none;">
            <div class="verification-success">
                <i class="fas fa-check-circle" style="font-size: 48px; margin-bottom: 15px;"></i>
                <h3>Transfert Trouv√© !</h3>
                <p>Votre transfert a √©t√© v√©rifi√© avec succ√®s</p>
            </div>

            <div class="grid">
                <!-- D√©tails du transfert -->
                <div class="transaction-details">
                    <h3 style="margin-bottom: 20px; color: var(--dark);">
                        <i class="fas fa-info-circle"></i> D√©tails du Transfert
                    </h3>
                    
                    <div class="detail-row">
                        <span class="detail-label">Num√©ro de transaction:</span>
                        <span class="detail-value" id="detail-id">-</span>
                    </div>
                    
                    <div class="detail-row">
                        <span class="detail-label">Date d'envoi:</span>
                        <span class="detail-value" id="detail-date">-</span>
                    </div>
                    
                    <div class="detail-row">
                        <span class="detail-label">Exp√©diteur:</span>
                        <span class="detail-value" id="detail-sender">-</span>
                    </div>
                    
                    <div class="detail-row">
                        <span class="detail-label">Destinataire:</span>
                        <span class="detail-value" id="detail-receiver">-</span>
                    </div>
                    
                    <div class="detail-row">
                        <span class="detail-label">Direction:</span>
                        <span class="detail-value" id="detail-direction">-</span>
                    </div>
                    
                    <div class="detail-row">
                        <span class="detail-label">Statut:</span>
                        <span class="detail-value">
                            <span id="detail-status" class="status-badge status-pending">-</span>
                        </span>
                    </div>
                </div>

                <!-- Montant et confirmation -->
                <div class="transaction-details">
                    <h3 style="margin-bottom: 20px; color: var(--dark);">
                        <i class="fas fa-money-bill-wave"></i> Montant √† Recevoir
                    </h3>
                    
                    <div class="amount-highlight">
                        <div id="detail-amount-sent">-</div>
                        <div style="font-size: 14px; margin-top: 5px; color: #666;">Montant envoy√©</div>
                    </div>
                    
                    <div class="amount-highlight" style="border-color: var(--secondary);">
                        <div id="detail-amount-receive">-</div>
                        <div style="font-size: 14px; margin-top: 5px; color: #666;">Montant √† recevoir</div>
                    </div>

                    <!-- Formulaire de confirmation de r√©ception -->
                    <div id="receive-form" style="display: none; margin-top: 20px;">
                        <h4 style="margin-bottom: 15px; color: var(--dark);">
                            <i class="fas fa-check-circle"></i> Confirmer la R√©ception
                        </h4>
                        
                        <div class="form-group">
                            <label for="receiver-confirm-id">Votre pi√®ce d'identit√©</label>
                            <input type="text" id="receiver-confirm-id" required placeholder="Num√©ro de carte d'identit√© ou passeport">
                            <small style="color: #666; font-size: 12px; margin-top: 5px; display: block;">
                                Doit correspondre au num√©ro fourni par l'exp√©diteur
                            </small>
                        </div>
                        
                        <div class="form-group">
                            <label for="receiver-confirm-phone">Votre t√©l√©phone</label>
                            <input type="tel" id="receiver-confirm-phone" required placeholder="Votre num√©ro de t√©l√©phone">
                            <small style="color: #666; font-size: 12px; margin-top: 5px; display: block;">
                                Doit correspondre au num√©ro fourni par l'exp√©diteur
                            </small>
                        </div>
                        
                        <button type="button" id="confirm-receive-btn" class="btn-success" style="width: 100%;">
                            <i class="fas fa-check"></i> Confirmer la R√©ception
                        </button>
                    </div>

                    <!-- Message si d√©j√† re√ßu -->
                    <div id="already-received" style="display: none; text-align: center; padding: 20px; background: #e8f5e8; border-radius: 10px;">
                        <i class="fas fa-check-circle" style="color: var(--secondary); font-size: 32px; margin-bottom: 10px;"></i>
                        <h4 style="color: var(--secondary);">Transfert D√©j√† Re√ßu</h4>
                        <p style="color: #666; margin-top: 10px;">Ce transfert a √©t√© r√©cup√©r√© le <span id="received-date">-</span></p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Message si aucun transfert trouv√© -->
        <div id="no-result" style="display: none; text-align: center; padding: 40px;">
            <i class="fas fa-search" style="font-size: 64px; color: #bdc3c7; margin-bottom: 20px;"></i>
            <h3 style="color: #7f8c8d;">Aucun transfert trouv√©</h3>
            <p style="color: #95a5a6;">V√©rifiez le num√©ro de transaction et votre nom</p>
        </div>
    </div>

    <!-- Notification -->
    <div id="notification" class="notification">
        <i class="fas fa-info-circle"></i>
        <span id="notification-text">Message de notification</span>
    </div>

    <script>
        // √âl√©ments DOM
        const verificationForm = document.getElementById('verification-form');
        const verificationResult = document.getElementById('verification-result');
        const noResult = document.getElementById('no-result');
        const receiveForm = document.getElementById('receive-form');
        const alreadyReceived = document.getElementById('already-received');
        const confirmReceiveBtn = document.getElementById('confirm-receive-btn');
        const notificationEl = document.getElementById('notification');

        // Variable pour stocker la transaction courante
        let currentTransaction = null;

        // R√©cup√©rer les donn√©es de session si disponibles
        const receiverName = sessionStorage.getItem('receiverName');
        const transactionToCheck = sessionStorage.getItem('transactionToCheck');

        // Pr√©-remplir le formulaire si des donn√©es existent
        if (receiverName) {
            document.getElementById('receiver-name').value = receiverName;
        }
        if (transactionToCheck) {
            document.getElementById('transaction-id').value = transactionToCheck;
        }

        // Soumission du formulaire de v√©rification
        verificationForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const name = document.getElementById('receiver-name').value.trim();
            const transactionId = document.getElementById('transaction-id').value.trim().toUpperCase();

            if (!name || !transactionId) {
                showNotification('Veuillez remplir tous les champs', 'error');
                return;
            }

            // Animation du bouton
            const submitBtn = verificationForm.querySelector('button');
            const originalText = submitBtn.innerHTML;
            submitBtn.innerHTML = '<div class="loading"></div> V√©rification...';
            submitBtn.disabled = true;

            try {
                await verifyTransaction(name, transactionId);
            } catch (error) {
                console.error('Erreur v√©rification:', error);
                showNotification('Erreur lors de la v√©rification', 'error');
            } finally {
                // R√©activer le bouton
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
            }
        });

        // V√©rifier la transaction dans Firebase
        async function verifyTransaction(receiverName, transactionId) {
            try {
                const { db, collection, getDocs, query, where } = window.firebase;
                
                console.log("Recherche transaction:", transactionId, "pour destinataire:", receiverName);
                
                // Recherche dans Firebase
                const transactionsQuery = query(
                    collection(db, "transactions"),
                    where("id", "==", transactionId)
                );
                
                const querySnapshot = await getDocs(transactionsQuery);
                
                if (!querySnapshot.empty) {
                    const transactionDoc = querySnapshot.docs[0];
                    const transaction = { 
                        id: transactionDoc.data().id,
                        firebaseId: transactionDoc.id, // Stocker l'ID Firebase
                        ...transactionDoc.data() 
                    };
                    
                    console.log("Transaction trouv√©e:", transaction);
                    
                    // V√©rifier le nom du destinataire
                    const cleanReceiverName = receiverName.toLowerCase().trim();
                    const storedReceiverName = transaction.receiver.name.toLowerCase().trim();
                    const storedReceiverSurname = transaction.receiver.surname.toLowerCase().trim();
                    const fullStoredName = `${storedReceiverName} ${storedReceiverSurname}`.trim();
                    
                    const nameMatches = storedReceiverName === cleanReceiverName || 
                                       fullStoredName === cleanReceiverName ||
                                       storedReceiverName.includes(cleanReceiverName) ||
                                       cleanReceiverName.includes(storedReceiverName);
                    
                    if (nameMatches) {
                        currentTransaction = transaction;
                        displayTransactionDetails(transaction);
                        verificationResult.style.display = 'block';
                        noResult.style.display = 'none';
                        showNotification('Transfert trouv√© avec succ√®s!', 'success');
                    } else {
                        verificationResult.style.display = 'none';
                        noResult.style.display = 'block';
                        showNotification('Le nom ne correspond pas au destinataire enregistr√©', 'error');
                    }
                } else {
                    // V√©rifier aussi dans le fallback localStorage
                    const fallbackTransactions = JSON.parse(localStorage.getItem('transactions_fallback')) || [];
                    const fallbackTransaction = fallbackTransactions.find(t => t.id === transactionId);
                    
                    if (fallbackTransaction) {
                        const cleanReceiverName = receiverName.toLowerCase().trim();
                        const storedReceiverName = fallbackTransaction.receiver.name.toLowerCase().trim();
                        const nameMatches = storedReceiverName === cleanReceiverName || 
                                           storedReceiverName.includes(cleanReceiverName) ||
                                           cleanReceiverName.includes(storedReceiverName);
                        
                        if (nameMatches) {
                            currentTransaction = fallbackTransaction;
                            displayTransactionDetails(fallbackTransaction);
                            verificationResult.style.display = 'block';
                            noResult.style.display = 'none';
                            showNotification('Transfert trouv√© (mode hors ligne)!', 'success');
                        } else {
                            verificationResult.style.display = 'none';
                            noResult.style.display = 'block';
                            showNotification('Le nom ne correspond pas au destinataire enregistr√©', 'error');
                        }
                    } else {
                        verificationResult.style.display = 'none';
                        noResult.style.display = 'block';
                        showNotification('Aucun transfert trouv√© avec ce num√©ro de transaction', 'error');
                    }
                }
            } catch (error) {
                console.error('Erreur v√©rification transaction:', error);
                throw error;
            }
        }

        // Afficher les d√©tails de la transaction
        function displayTransactionDetails(transaction) {
            console.log("Affichage d√©tails transaction:", transaction);
            
            // Mettre √† jour les d√©tails
            document.getElementById('detail-id').textContent = transaction.id;
            document.getElementById('detail-date').textContent = formatDate(transaction.date);
            document.getElementById('detail-sender').textContent = `${transaction.sender.name} ${transaction.sender.surname}`;
            document.getElementById('detail-receiver').textContent = `${transaction.receiver.name} ${transaction.receiver.surname}`;
            
            const direction = transaction.transferType === 'RD_HAITI' 
                ? 'üá©üá¥ R√©publique Dominicaine ‚Üí Ha√Øti üá≠üáπ' 
                : 'üá≠üáπ Ha√Øti ‚Üí R√©publique Dominicaine üá©üá¥';
            document.getElementById('detail-direction').textContent = direction;
            
            // Mettre √† jour les montants
            document.getElementById('detail-amount-sent').textContent = 
                `${transaction.amount} ${transaction.currencyFrom}`;
            document.getElementById('detail-amount-receive').textContent = 
                `${transaction.convertedAmount.toLocaleString('fr-FR')} ${transaction.currencyTo}`;
            
            // Mettre √† jour le statut
            const statusElement = document.getElementById('detail-status');
            statusElement.textContent = getStatusText(transaction.status);
            statusElement.className = `status-badge status-${transaction.status}`;
            
            // Afficher le formulaire de r√©ception ou le message "d√©j√† re√ßu"
            if (transaction.status === 'pending') {
                receiveForm.style.display = 'block';
                alreadyReceived.style.display = 'none';
                
                // Configurer le bouton de confirmation
                confirmReceiveBtn.onclick = () => confirmReceipt(transaction.id);
            } else {
                receiveForm.style.display = 'none';
                alreadyReceived.style.display = 'block';
                if (transaction.receivedDate) {
                    document.getElementById('received-date').textContent = formatDate(transaction.receivedDate);
                }
            }
        }

        // CORRECTION : Confirmer la r√©ception avec v√©rification des identifiants
        async function confirmReceipt(transactionId) {
            const idNumber = document.getElementById('receiver-confirm-id').value.trim();
            const phone = document.getElementById('receiver-confirm-phone').value.trim();
            
            if (!idNumber || !phone) {
                showNotification('Veuillez remplir tous les champs', 'error');
                return;
            }

            // V√âRIFICATION : Comparer avec les informations originales
            if (currentTransaction) {
                const originalId = currentTransaction.receiver.id;
                const originalPhone = currentTransaction.receiver.phone;
                
                console.log('V√©rification identifiants:', {
                    providedId: idNumber,
                    originalId: originalId,
                    providedPhone: phone,
                    originalPhone: originalPhone
                });

                if (idNumber !== originalId) {
                    showNotification('Le num√©ro d\'identit√© ne correspond pas √† celui enregistr√© par l\'exp√©diteur', 'error');
                    return;
                }

                if (phone !== originalPhone) {
                    showNotification('Le num√©ro de t√©l√©phone ne correspond pas √† celui enregistr√© par l\'exp√©diteur', 'error');
                    return;
                }
            }

            // Animation du bouton
            const originalText = confirmReceiveBtn.innerHTML;
            confirmReceiveBtn.innerHTML = '<div class="loading"></div> Traitement...';
            confirmReceiveBtn.disabled = true;

            try {
                // V√©rifier si c'est une transaction Firebase ou fallback
                if (currentTransaction.firebaseId) {
                    // CORRECTION : Transaction Firebase - utiliser l'ID Firebase pour la mise √† jour
                    const { db, collection, getDocs, query, where, doc, updateDoc } = window.firebase;
                    
                    console.log("üîç Recherche de la transaction avec ID:", transactionId);
                    
                    // Rechercher le document par notre ID personnalis√©
                    const transactionsQuery = query(
                        collection(db, "transactions"),
                        where("id", "==", transactionId)
                    );
                    
                    const querySnapshot = await getDocs(transactionsQuery);
                    
                    if (querySnapshot.empty) {
                        throw new Error("Transaction non trouv√©e dans la base de donn√©es");
                    }
                    
                    // R√©cup√©rer le document Firebase (avec son ID auto-g√©n√©r√©)
                    const transactionDoc = querySnapshot.docs[0];
                    const firebaseDocId = transactionDoc.id;
                    
                    console.log("‚úÖ Document trouv√©. ID Firebase:", firebaseDocId);
                    
                    // Mettre √† jour le document avec l'ID Firebase correct
                    await updateDoc(doc(db, "transactions", firebaseDocId), {
                        status: 'completed',
                        received: true,
                        receivedDate: new Date().toISOString(),
                        receiver: {
                            ...currentTransaction.receiver,
                            confirmedId: idNumber,
                            confirmedPhone: phone
                        }
                    });
                    
                    console.log("‚úÖ Transaction mise √† jour avec succ√®s dans Firebase");
                    
                } else {
                    // Transaction fallback - mettre √† jour localStorage
                    const fallbackTransactions = JSON.parse(localStorage.getItem('transactions_fallback')) || [];
                    const transactionIndex = fallbackTransactions.findIndex(t => t.id === transactionId);
                    
                    if (transactionIndex !== -1) {
                        fallbackTransactions[transactionIndex].status = 'completed';
                        fallbackTransactions[transactionIndex].received = true;
                        fallbackTransactions[transactionIndex].receivedDate = new Date().toISOString();
                        fallbackTransactions[transactionIndex].receiver.confirmedId = idNumber;
                        fallbackTransactions[transactionIndex].receiver.confirmedPhone = phone;
                        
                        localStorage.setItem('transactions_fallback', JSON.stringify(fallbackTransactions));
                        currentTransaction = fallbackTransactions[transactionIndex];
                    }
                }
                
                // Mettre √† jour l'affichage
                currentTransaction.status = 'completed';
                currentTransaction.received = true;
                currentTransaction.receivedDate = new Date().toISOString();
                displayTransactionDetails(currentTransaction);
                
                showNotification('R√©ception confirm√©e avec succ√®s! Les identifiants correspondent.', 'success');
                
                // Envoyer une notification √† l'exp√©diteur (simul√©)
                sendConfirmationSMS(currentTransaction);
                
            } catch (error) {
                console.error('‚ùå Erreur confirmation r√©ception:', error);
                showNotification('Erreur lors de la confirmation: ' + error.message, 'error');
            } finally {
                // R√©activer le bouton
                confirmReceiveBtn.innerHTML = originalText;
                confirmReceiveBtn.disabled = false;
            }
        }

        // Envoyer une confirmation SMS (simul√©)
        function sendConfirmationSMS(transaction) {
            const direction = transaction.transferType === 'RD_HAITI' ? 'R√©publique Dominicaine vers Ha√Øti' : 'Ha√Øti vers R√©publique Dominicaine';
            
            console.log(`SMS envoy√© √† ${transaction.sender.phone}: 
            Bonne nouvelle! ${transaction.receiver.name} a r√©cup√©r√© le transfert de ${transaction.amount} ${transaction.currencyFrom}. 
            Transaction #${transaction.id} est maintenant compl√©t√©e.`);
            
            showNotification(`Confirmation envoy√©e √† ${transaction.sender.phone}`, 'success');
        }

        // Fonction pour afficher une notification
        function showNotification(message, type) {
            const icon = type === 'error' ? 'fa-exclamation-circle' : 'fa-check-circle';
            notificationEl.innerHTML = `<i class="fas ${icon}"></i><span>${message}</span>`;
            notificationEl.className = `notification ${type} show`;

            setTimeout(() => {
                notificationEl.classList.remove('show');
            }, 4000);
        }

        // Fonctions utilitaires
        function formatDate(dateString) {
            try {
                const date = new Date(dateString);
                return date.toLocaleDateString('fr-FR') + ' √† ' + date.toLocaleTimeString('fr-FR', {hour: '2-digit', minute: '2-digit'});
            } catch (error) {
                return dateString;
            }
        }

        function getStatusText(status) {
            const statusMap = {
                'pending': 'En attente',
                'completed': 'Compl√©t√©',
                'cancelled': 'Annul√©'
            };
            return statusMap[status] || status;
        }

        // V√©rification automatique si des donn√©es pr√©-remplies existent
        document.addEventListener('DOMContentLoaded', () => {
            console.log("Page r√©ception charg√©e");
            
            if (receiverName && transactionToCheck) {
                console.log("Donn√©es pr√©-remplies trouv√©es:", { receiverName, transactionToCheck });
                // Lancer automatiquement la v√©rification
                setTimeout(() => {
                    verifyTransaction(receiverName, transactionToCheck);
                    
                    // Nettoyer la session
                    sessionStorage.removeItem('receiverName');
                    sessionStorage.removeItem('transactionToCheck');
                }, 500);
            }
        });

        // Gestion des erreurs globales
        window.addEventListener('error', (event) => {
            console.error('Erreur globale:', event.error);
            showNotification('Une erreur est survenue', 'error');
        });
    </script>
</body>
</html>
